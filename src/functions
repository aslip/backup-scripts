# vim: set ft=sh:


# dumps a mysql database to the specified file using proper mysqldump options
#
# depends on global variables $DB, $USER, $PASS, $XTRA_OPT
# $PASS may be set to "-" to indicate an empty password
dump_to() {
    local DST=$1

    # -q (quick) - dump one row at a time, without buffering
    # -Q - quote names with `
    # --create-options - dump mysql-specific options for create statements
    # --skip-dump-date - omit dump date from the last comment in dump file
    #                       (i.e. "Dump completed on ...") to simplify tests
    local OPT="\
    --create-options 
        --set-charset 
        --skip-extended-insert
        --skip-dump-date
        --max-allowed-packet=8M -Qq"
    if [[ $PASS == - ]]; then # empty password
        local PASS_OPT=
    else
        local PASS_OPT='-p"'$PASS'"'
    fi

    # using eval to correctly handle $PASS_OPT
    eval mysqldump $OPT $XTRA_OPT -u"$USER" "$PASS_OPT" "$DB" > "$DST"
}


# makes a list of mysqldump ignore-table options from a list
# of names of tables to be ignored and a database name
#
# example:
#   make_ignore_table_option "table1 table2" database
# will output
#   --ignore-table=database.table1 --ignore-table=database.table2
make_ignore_table_option() {
    local TABLES=$1
    local DB=$2
    for table in $TABLES; do
        # no trailing newline
        echo -n "--ignore-table=$DB.$table "
    done
}

